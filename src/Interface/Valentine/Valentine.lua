

local g_Word_Group1 = {
	[1] = {
		skillname="#{YDSS_15018_204}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_17",
	},
	[2] = {
		skillname="#{YDSS_15018_205}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_13",
	},
	[3] = {
		skillname="#{YDSS_15018_206}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_14",
	},
	[4] = {
		skillname="#{YDSS_15018_207}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_18",
	},
	[5] = {
		skillname="#{YDSS_15018_208}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_07",
	},
	[6] = {
		skillname="#{YDSS_15018_209}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_15",
	},
	[7] = {
		skillname="#{YDSS_15018_210}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_19",
	},
	[8] = {
		skillname="#{YDSS_15018_211}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_20",
	},
	[9] = {
		skillname="#{YDSS_15018_212}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_16",
	},
	[10] = {
		skillname="#{YDSS_15018_213}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_14",
	},
	[11] = {
		skillname="#{YDSS_15018_214}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_17",
	},
	[12] = {
		skillname="#{YDSS_15018_215}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_21",
	},
	[13] = {
		skillname="#{YDSS_15018_216}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_02",
	},
	[14] = {
		skillname="#{YDSS_15018_217}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_18",
	},
}

local g_Word_Group2 = {
	[1] = {
		skillname="#{YDSS_15018_218}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_01",
	},
	[2] = {
		skillname="#{YDSS_15018_219}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_02",
	},
	[3] = {
		skillname="#{YDSS_15018_220}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_01",
	},
	[4] = {
		skillname="#{YDSS_15018_221}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_02",
	},
	[5] = {
		skillname="#{YDSS_15018_222}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_03",
	},
	[6] = {
		skillname="#{YDSS_15018_223}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_03",
	},
	[7] = {
		skillname="#{YDSS_15018_224}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_04",
	},
	[8] = {
		skillname="#{YDSS_15018_225}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_04",
	},
	[9] = {
		skillname="#{YDSS_15018_226}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_05",
	},
	[10] = {
		skillname="#{YDSS_15018_227}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_05",
	},
	[11] = {
		skillname="#{YDSS_15018_228}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_06",
	},
	[12] = {
		skillname="#{YDSS_15018_229}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_07",
	},
	[13] = {
		skillname="#{YDSS_15018_230}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_06",
	},
	[14] = {
		skillname="#{YDSS_15018_231}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_08",
	},
}

local g_Word_Group3 = {
	[1] = {
		skillname="#{YDSS_15018_232}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_09",
	},
	[2] = {
		skillname="#{YDSS_15018_233}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_07",
	},
	[3] = {
		skillname="#{YDSS_15018_234}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_10",
	},
	[4] = {
		skillname="#{YDSS_15018_235}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_11",
	},
	[5] = {
		skillname="#{YDSS_15018_236}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_12",
	},
	[6] = {
		skillname="#{YDSS_15018_237}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_08",
	},
	[7] = {
		skillname="#{YDSS_15018_238}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_09",
	},
	[8] = {
		skillname="#{YDSS_15018_239}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_13",
	},
	[9] = {
		skillname="#{YDSS_15018_240}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_14",
	},
	[10] = {
		skillname="#{YDSS_15018_241}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_10",
	},
	[11] = {
		skillname="#{YDSS_15018_242}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_15",
	},
	[12] = {
		skillname="#{YDSS_15018_243}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_11",
	},
	[13] = {
		skillname="#{YDSS_15018_244}", s = 1,
		iconbase = "set:ValentinePoem1 image:ValentinePoem1_16",
	},
	[14] = {
		skillname="#{YDSS_15018_245}", s = 0,
		iconbase = "set:ValentinePoem2 image:ValentinePoem2_12",
	},
}

local g_mission_id = 1347
local g_buf_set = { 39573,39574,39575,39576,39577,39578 }

local g_Word_Buttons = {}
local g_Word_Flashes = {}

local g_Stone_Pos = {
	[0] 	= {368,408},
	[1] 	= {259,411},
	[164] 	= {270,72},
}

local g_last_team_state = 0
local g_last_in_area = 0


function Valentine_PreLoad()
	this:RegisterEvent("UI_COMMAND")
	
	this:RegisterEvent("UPDATE_MISSION_TRACK")
	this:RegisterEvent("NEW_MISSION")
end

function Valentine_OnLoad()
	for i=1,14 do
		g_Word_Buttons[i] = _G[ string.format("Valentine_Word%d_Image",i) ]
		g_Word_Flashes[i] = _G[ string.format("Valentine_Word%d_AnimateImage",i) ]
	end
end

function Valentine_OnEvent(event)
	if event == "UI_COMMAND" and tonumber(arg0) == 8910321 then
		Valentine_UpdateState()
	end
	if event == "UPDATE_MISSION_TRACK" or event == "NEW_MISSION" then
		Valentine_TimerUpdate()
	end
end

function Valentine_TimerHandler()

	local bNotify = 0
	if Player:IsInTeam() == 0 then
		if g_last_team_state ~= 0 then
			bNotify = 1
		end
		g_last_team_state = 0
	else
		local n = DataPool:GetTeamMemberCount()
		if n < g_last_team_state then
			bNotify = 1
		end
		g_last_team_state = n
	end
	
	local sId = GetSceneID()
	if g_Stone_Pos[sId] == nil then
		if g_last_in_area == 1 then
			bNotify = 1
		end
		g_last_in_area = 0
	else
		sp = g_Stone_Pos[sId]
		x,z = Player:GetPos()
		if ( x - sp[1] ) * ( x - sp[1] ) +  ( z - sp[2] ) * ( z - sp[2] ) > 100 then
			if g_last_in_area == 1 then
				bNotify = 1
			end
			g_last_in_area = 0
		else
			g_last_in_area = 1
		end
	end
	
	if bNotify == 1 and this:IsVisible() then
		Clear_XSCRIPT()
			Set_XSCRIPT_Function_Name("UpdateQteStatus")
			Set_XSCRIPT_ScriptID(891032)
			Set_XSCRIPT_ParamCount(0)
		Send_XSCRIPT()
	end
end

function Valentine_TimerUpdate()
	KillTimer("Valentine_TimerHandler()")
	if DataPool:Lua_IsHaveMission(g_mission_id) == 1 then
		SetTimer( "Valentine", "Valentine_TimerHandler()", 300 )
	end
end

function Valentine_OnOkClicked()
	Clear_XSCRIPT()
		Set_XSCRIPT_Function_Name("OnUserFinish")
		Set_XSCRIPT_ScriptID(891032)
		Set_XSCRIPT_ParamCount(0)
	Send_XSCRIPT()
end

function Valentine_GetBit( n , b , l )
	return math.floor( math.mod( n , math.pow(2, b+l ) ) / math.pow( 2, b ) )
end
		
function Valentine_MakeWordStates( n )
	local set = {}
	for i = 1, 14 do
		set[i] = Valentine_GetBit( n , i-1, 1 )
	end
	return set, Valentine_GetBit( n , 14, 6 )
end

function Valentine_UpdateState()
	
	Valentine_TimerUpdate()
	
	local nGroup = Get_XParam_INT(0)
	local States,nNext = Valentine_MakeWordStates( Get_XParam_INT( 1 ) )
	local usrName = Get_XParam_STR(0)
	
	if nGroup == 0 then
		this:Hide()
		return
	end
	local Groups = {g_Word_Group1,g_Word_Group2,g_Word_Group3}
	local GroupData = Groups[ nGroup ]
	if GroupData == nil then
		return
	end
	if not this:IsVisible() then
		this:Show()
	end
	
	for i = 1, 14 do
		if nNext > i then
			if States[i] == 1 then
				g_Word_Buttons[i]:SetProperty( "Image", GroupData[i].iconbase .. "_Hover" )
				if GroupData[i].s == 0 then
					g_Word_Flashes[i]:SetProperty("Animate","ValentinePoem_pinkstar")
				else
					g_Word_Flashes[i]:SetProperty("Animate","ValentinePoem_bluestar")
				end
				g_Word_Flashes[i]:Show()
			else
				g_Word_Buttons[i]:SetProperty( "Image", GroupData[i].iconbase .. "_Disable" )
				g_Word_Flashes[i]:Hide()
			end
		elseif nNext == i then
			g_Word_Buttons[i]:SetProperty( "Image", GroupData[i].iconbase .. "_Pushed" )
			Valentine_Explain:SetText( ScriptGlobal_Format( "#{YDSS_15018_99}", usrName, GroupData[i].skillname ) )
			if GroupData[i].s == 0 then
				g_Word_Flashes[i]:SetProperty("Animate","ValentinePoem_pink")
			else
				g_Word_Flashes[i]:SetProperty("Animate","ValentinePoem_blue")
			end
			g_Word_Flashes[i]:Show()
		else
			g_Word_Buttons[i]:SetProperty( "Image", GroupData[i].iconbase .. "_Normal" )
			g_Word_Flashes[i]:Hide()
		end
	end
end
